<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Secure-Mail | Home</title>
  <link rel="stylesheet" href="/css/home.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <header class="topbar">
      <div>
        <h1 class="brand">Secure-Mail</h1>
        <p class="muted">Encrypted ‚Ä¢ Signed ‚Ä¢ Verified</p>
      </div>

      <div class="topbar-right">
        <div class="userpill">
          <span class="muted">Logged in as</span>
          <strong id="usernameLabel">...</strong>
        </div>
        <button class="btn btn-secondary" id="logoutBtn">Logout</button>
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <h2>Compose Message</h2>
        <p class="muted">Encrypt message with AES, encrypt AES key with recipient public key, sign hash with your private key.</p>

        <form id="composeForm" class="form">
          <label>
            Recipient username
            <input type="text" id="recipient" placeholder="e.g. emine" required />
          </label>

          <label>
            Message
            <textarea id="message" rows="6" placeholder="Write your secure message..." required></textarea>
          </label>

          <div class="row">
            <button class="btn" type="submit">
              <i class="fa-solid fa-paper-plane"></i> Send Secure Message
            </button>
            <button class="btn btn-secondary" type="button" id="clearBtn">Clear</button>
          </div>

          <div id="composeStatus" class="status"></div>
        </form>
      </section>

      <section class="card">
        <div class="card-head">
          <h2>Inbox</h2>
          <button class="btn btn-secondary" id="refreshInboxBtn" type="button">
            <i class="fa-solid fa-rotate"></i> Refresh
          </button>
        </div>

        <ul id="inboxList" class="list">
          <li class="muted">Loading messages...</li>
        </ul>
      </section>

      <section class="card">
        <h2>Verification Process</h2>
        <p class="muted">
          When you click "Decrypt", the system performs these operations in real-time:
        </p>

        <div class="kv">
          <div class="kv-row"><span class="muted">1. Decrypt Key</span><span class="badge">RSA Private Key</span></div>
          <div class="kv-row"><span class="muted">2. Decrypt Content</span><span class="badge">AES-256</span></div>
          <div class="kv-row"><span class="muted">3. Verify Integrity</span><span class="badge">SHA-256 Hash</span></div>
          <div class="kv-row"><span class="muted">4. Authenticate</span><span class="badge">Verify Digital Signature</span></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Login Check & Logout
    const usernameLabel = document.getElementById("usernameLabel");
    const logoutBtn = document.getElementById("logoutBtn");

    const params = new URLSearchParams(window.location.search);
    const currentUser = params.get("u");

    if (!currentUser) {
      alert("No user logged in! Redirecting...");
      window.location.href = "/login.html";
    } else {
      usernameLabel.textContent = currentUser;
    }

    logoutBtn.addEventListener("click", () => {
      window.location.href = "/login.html";
    });

    // Sending Messages
    const composeForm = document.getElementById("composeForm");
    const composeStatus = document.getElementById("composeStatus");
    const clearBtn = document.getElementById("clearBtn");

    clearBtn.addEventListener("click", () => {
      document.getElementById("recipient").value = "";
      document.getElementById("message").value = "";
      composeStatus.innerHTML = ""; 
    });

    composeForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      composeStatus.innerHTML = "Encrypting and sending..."; 
      composeStatus.className = "status";

      const recipient = document.getElementById("recipient").value.trim();
      const content = document.getElementById("message").value.trim();
  
      const senderPassword = prompt("Enter your password to sign the message:");
      if (!senderPassword) {
        composeStatus.innerHTML = `<span class="status-error">‚ùå Sending cancelled (password required).</span>`;
        return;
      }

      try {
        const res = await fetch("/api/messages/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            senderUsername: currentUser,
            senderPassword: senderPassword,
            recipientUsername: recipient,
            content: content
          })
        });

        // TOAST NOTIFICATION
        if (res.ok) {
          
          composeStatus.innerHTML = `
            <div class="toast-success">
              ‚úÖ Message Sent Successfully!
            </div>
          `;
          
          
          document.getElementById("message").value = "";

          
          setTimeout(() => {
            composeStatus.innerHTML = "";
          }, 3000);

        } else {
          
          const text = await res.text();
          composeStatus.innerHTML = `<span class="status-error">‚ùå Error: ${text}</span>`;
        }
        // -------------------------------------------

      } catch (err) {
        console.error(err);
        composeStatus.innerHTML = `<span class="status-error">‚ùå Network Error</span>`;
      }
    });

    // Inbox
    const inboxList = document.getElementById("inboxList");
    const refreshInboxBtn = document.getElementById("refreshInboxBtn");

    async function loadInbox() {
      inboxList.innerHTML = '<li class="muted">Loading...</li>';
      try {
        const res = await fetch(`/api/messages/inbox?username=${currentUser}`);
        const messages = await res.json();

        if (messages.length === 0) {
          inboxList.innerHTML = '<li class="muted">No messages found.</li>';
          return;
        }

        inboxList.innerHTML = ""; 

        messages.forEach(msg => {
          const li = document.createElement("li");
          const date = new Date(msg.createdAt).toLocaleString();
          
          li.innerHTML = `
            <div class="msg-header">
              <span class="msg-sender">From: ${msg.sender ? msg.sender.username : "Unknown"}</span>
              <span class="msg-date">${date}</span>
            </div>
            <div class="msg-body">
              <p class="muted" style="font-size:12px; word-break:break-all;">
                üîí Encrypted: ${msg.encryptedMessage.substring(0, 30)}...
              </p>
              
              <button class="btn btn-secondary" onclick="decryptMessage('${msg._id}', this)">
                <i class="fa-solid fa-key"></i> Decrypt & Read
              </button>

            </div>
            <div class="decrypted-container" id="decrypted-${msg._id}"></div>
          `;
          inboxList.appendChild(li);
        });

      } catch (err) {
        console.error(err);
        inboxList.innerHTML = '<li class="muted status-error">Failed to load inbox.</li>';
      }
    }

    // DECRYPT
    window.decryptMessage = async (messageId, btnElement) => {
      const container = document.getElementById(`decrypted-${messageId}`);
      
      const password = prompt("Enter your password to decrypt:");
      if (!password) return;

      btnElement.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Decrypting...`;
      btnElement.disabled = true;

      try {
        const res = await fetch("/api/messages/decrypt", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            messageId: messageId,
            username: currentUser,
            password: password
          })
        });

        const data = await res.json();

        if (res.ok) {
          const sigClass = data.isSignatureValid ? "sig-valid" : "sig-invalid";
          const sigIcon = data.isSignatureValid ? "‚úÖ" : "‚ùå";
          const sigText = data.isSignatureValid ? "Signature Verified (Authentic)" : "Signature INVALID!";

          const intClass = data.isIntegrityIntact ? "sig-valid" : "sig-invalid";
          const intIcon = data.isIntegrityIntact ? "‚úÖ" : "‚ùå";
          const intText = data.isIntegrityIntact ? "Integrity OK" : "Integrity FAILED!";


          container.innerHTML = `
        <div class="decrypted-box">
          <p style="margin:0; font-size:15px; color:#fff;">${data.content}</p>

          <div class="signature-badge ${sigClass}">
            ${sigIcon} ${sigText}
          </div>

          <div class="signature-badge ${intClass}">
            ${intIcon} ${intText}
          </div>
        </div>
      `;
          
          
          btnElement.innerHTML = `<i class="fa-solid fa-lock-open"></i> Decrypted`;
    } else {
      btnElement.innerHTML = `<i class="fa-solid fa-key"></i> Decrypt & Read`;
      btnElement.disabled = false;
      alert("Decryption Failed: " + (data.error || "Unknown error"));
    }
  } catch (err) {
    console.error(err);
    btnElement.innerHTML = `<i class="fa-solid fa-key"></i> Decrypt & Read`;
    btnElement.disabled = false;
    alert("Network error during decryption.");
  }
};

    refreshInboxBtn.addEventListener("click", loadInbox);
    loadInbox();

  </script>
</body>
</html>